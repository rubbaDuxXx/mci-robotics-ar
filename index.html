<!DOCTYPE html>
<html>
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <!-- we import arjs version without NFT but with marker + location based support -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script type="text/javascript" src="lib/TcAdsWebService.js"></script>
  <script type="text/javascript">
    (function () {

        var NETID = "192.168.26.102.1.1"; // Empty string for local machine;
        var PORT = "851"; // TC2 PLC Runtime = 801, TC3 PLC Runtime = 851
        var SERVICE_URL = "http://http://193.171.211.131:8080/TcAdsWebService/TcAdsWebService.dll"; // HTTP path to the TcAdsWebService;

        var client = new TcAdsWebService.Client(SERVICE_URL, null, null);

        var general_timeout = 500;

        // Array of symbol names to read;
        var handlesVarNames = [
                "MAIN.byteValue",
                "MAIN.wordValue",
                "MAIN.dwordValue",
                "MAIN.sintValue",
                "MAIN.intValue",
                "MAIN.dintValue",
                "MAIN.realValue",
                "MAIN.lrealValue"
            ];

        var handlesVarSizes = [ 1, 2, 4, 1, 2, 4, 4, 8 ];

        var handles = [];


        // Occurs if the window has loaded;
        window.onload = (function () {

            // Register ui events
            btnWrite.onclick = BtnWriteClicked;

            // Create sumcommando for reading twincat symbol handles by symbol name;
            var handleswriter = new TcAdsWebService.DataWriter();

            // Write general information for each symbol handle to the TcAdsWebService.DataWriter object;
            for (var i = 0; i < handlesVarNames.length; i++) {
                handleswriter.writeDINT(TcAdsWebService.TcAdsReservedIndexGroups.SymbolHandleByName);
                handleswriter.writeDINT(0);
                handleswriter.writeDINT(4); // Expected size; A handle has a size of 4 byte;
                handleswriter.writeDINT(handlesVarNames[i].length); // The length of the symbol name string;
            }

            // Write symbol names after the general information to the TcAdsWebService.DataWriter object;
            for (var i = 0; i < handlesVarNames.length; i++) {
                handleswriter.writeString(handlesVarNames[i]);
            }

            // Send the list-read-write command to the TcAdsWebService by use of the readwrite function of the TcAdsWebService.Client object;
            client.readwrite(
                NETID,
                PORT,
                0xF082,     // IndexGroup = ADS list-read-write command; Used to request handles for twincat symbols;
                handlesVarNames.length, // IndexOffset = Count of requested symbol handles;
                (handlesVarNames.length * 4) + (handlesVarNames.length * 8), // Length of requested data + 4 byte errorcode and 4 byte length per twincat symbol;
                handleswriter.getBase64EncodedData(),
                RequestHandlesCallback,
                null,
                general_timeout,
                RequestHandlesTimeoutCallback,
                true);

        });

        // Occurs if the readwrite for the sumcommando has finished;
        var RequestHandlesCallback = (function (e, s) {

            if (e && e.isBusy) {
                // HANDLE PROGRESS TASKS HERE;
                var message = "Requesting symbol handles...";
                div_log.innerHTML = message;
                // Exit callback function because request is still busy;
                return;
            }

            if (e && !e.hasError) {

                // Get TcAdsWebService.DataReader object from TcAdsWebService.Response object;
                var reader = e.reader;

                // Read error code and length for each handle;
                for (var i = 0; i < handlesVarNames.length; i++) {

                    var err = reader.readDWORD();
                    var len = reader.readDWORD();

                    if (err != 0) {
                        div_log.innerHTML = "Symbol handle error!";
                        return;
                    }

                }

                var message = "Symbol handles successfully created!";
                div_log.innerHTML = message;

                // Read handles from TcAdsWebService.DataReader object;
                handles[0] = reader.readDWORD();
                handles[1] = reader.readDWORD();
                handles[2] = reader.readDWORD();
                handles[3] = reader.readDWORD();
                handles[4] = reader.readDWORD();
                handles[5] = reader.readDWORD();
                handles[6] = reader.readDWORD();
                handles[7] = reader.readDWORD();

            } else {

                if (e.error.getTypeString() == "TcAdsWebService.ResquestError") {
                    // HANDLE TcAdsWebService.ResquestError HERE;
                    div_log.innerHTML = "Error: StatusText = " + e.error.statusText + " Status: " + e.error.status;
                }
                else if (e.error.getTypeString() == "TcAdsWebService.Error") {
                    // HANDLE TcAdsWebService.Error HERE;
                    div_log.innerHTML = "Error: ErrorMessage = " + e.error.errorMessage + " ErrorCode: " + e.error.errorCode;
                }

            }

        });

        // Occurs if the readwrite for the sumcommando to request symbol handles runs into timeout;
        var RequestHandlesTimeoutCallback = (function () {
            // HANDLE TIMEOUT HERE;
            div_log.innerHTML = "Requuest symbol handles timeout!";
        });

          var BtnWriteClicked = (function () {

            // Create TcAdsWebService.DataWriter for write-read-write command.
            var writer = new TcAdsWebService.DataWriter();

            // Write general write-read-write commando information to TcAdsWebService.DataWriter object;
            var size = 0;
            for (var i = 0; i < handles.length; i++) {
                writer.writeDINT(TcAdsWebService.TcAdsReservedIndexGroups.SymbolValueByHandle);
                writer.writeDINT(handles[i]);
                writer.writeDINT(handlesVarSizes[i]);

                size = size + handlesVarSizes[i];
            }

            // Write values to TcAdsWebService.DataWrite object;
            writer.writeBYTE(parseFloat(Text1.value));
            writer.writeWORD(parseFloat(Text2.value));
            writer.writeDWORD(parseFloat(Text3.value));
            writer.writeSINT(parseFloat(Text4.value));
            writer.writeINT(parseFloat(Text5.value));
            writer.writeDINT(parseFloat(Text6.value));
            writer.writeREAL(parseFloat(Text7.value));
            writer.writeLREAL(parseFloat(Text8.value));

            client.readwrite(
                    NETID,
                    PORT,
                    0xF081, // 0xF081 = Call Write SumCommando
                    handles.length, // IndexOffset = Count of requested variables.
                    size+(handles.length*4), // Length of requested data + 4 byte errorcode per variable.
                    writer.getBase64EncodedData(),
                    WriteCallback,
                    null,
                    general_timeout,
                    WriteTimeoutCallback,
                    true);
        });

        var WriteCallback = (function(e,s){

            if (e && e.isBusy) {
                // HANDLE PROGRESS TASKS HERE;
                var message = "Writing data to plc...";
                div_log.innerHTML = message;
                // Exit callback function because request is still busy;
                return;
            }

            if (e && !e.hasError) {

                var message = "Writing data successfully finished...";
                div_log.innerHTML = message;

            } else {

                if (e.error.getTypeString() == "TcAdsWebService.ResquestError") {
                    // HANDLE TcAdsWebService.ResquestError HERE;
                    div_log.innerHTML = "Error: StatusText = " + e.error.statusText + " Status: " + e.error.status;
                }
                else if (e.error.getTypeString() == "TcAdsWebService.Error") {
                    // HANDLE TcAdsWebService.Error HERE;
                    div_log.innerHTML = "Error: ErrorMessage = " + e.error.errorMessage + " ErrorCode: " + e.error.errorCode;
                }

            }
        });

        // Occurs if the write-read-write command runs into timeout;
        var WriteTimeoutCallback = (function () {
            // HANDLE TIMEOUT HERE;
            div_log.innerHTML = "Write timeout!";
        });

    })();
</script>
  <body style="margin : 0px; overflow: scroll;">
    <h1>TcAdsWebService.js Sample02</h1>
    <h2>Write multiple variables with sumcommando!</h2>
    <table>
        <tr>
            <td>MAIN.byteValue:</td>
            <td><input id="Text1" type="text" /></td>
        </tr>
        <tr>
            <td>MAIN.wordValue:</td>
            <td><input id="Text2" type="text" /></td>
        </tr>
        <tr>
            <td>MAIN.dwordValue:</td>
            <td><input id="Text3" type="text" /></td>
        </tr>
        <tr>
            <td>MAIN.sintValue:</td>
            <td><input id="Text4" type="text" /></td>
        </tr>
        <tr>
            <td>MAIN.intValue:</td>
            <td><input id="Text5" type="text" /></td>
        </tr>
        <tr>
            <td>MAIN.dintValue:</td>
            <td><input id="Text6" type="text" /></td>
        </tr>
        <tr>
            <td>MAIN.realValue:</td>
            <td><input id="Text7" type="text" /></td>
        </tr>
        <tr>
            <td>MAIN.lrealValue:</td>
            <td><input id="Text8" type="text" /></td>
        </tr>
    </table>
    <input type="button" id="btnWrite" value="Write Values to PLC" />
    <div id="div_log"></div>
    <a-scene embedded arjs>
      <!-- handle hiro marker -->
		<a-marker preset='hiro'>
			<a-box position='0 0.5 0' material='opacity: 0.2; side: double;color:white;'>
				<a-torus-knot radius='0.26' radius-tubular='0.05' material='opacity: 1; side: double;color:red;'
				animation="property: rotation; to:360 0 0; dur: 5000; easing: linear; loop: true">
				</a-torus-knot>
            </a-box>
        </a-marker>
        
        <!-- handle kanji marker -->
		<a-marker preset='kanji'>
			<a-box position='0 0.5 0' material='opacity: 0.2; side: double;color:white;'>
				<a-torus-knot radius='0.26' radius-tubular='0.05' material='opacity: 1; side: double;color:green;'
				animation="property: rotation; to:360 0 0; dur: 5000; easing: linear; loop: true">
				</a-torus-knot>
			</a-box>
        </a-marker>
        

      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>